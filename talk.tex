\documentclass[14pt]{beamer}
\usepackage{listings}
\usepackage{inconsolata}
\usepackage[T1]{fontenc}
\usepackage[scaled]{helvet}
\renewcommand*\familydefault{\sfdefault}

\lstset{
  basicstyle=\ttfamily
}

\title{Using OpenStreetMap data with Python}
\author{Andrii V. Mishkovskyi}
\date{\today}


\begin{document}

% \begin{frame}{Test}
%   \begin{center}
%     \lstinputlisting[language=Python]{./importing.py}
%   \end{center}
% \end{frame}

\begin{frame}
  \titlepage
\end{frame}

\begin{frame}
  \tableofcontents
\end{frame}

\section{Introduction}

\subsection{Definitions}
\label{sec:definitions}

\begin{frame}
  \frametitle{Outline}
  \begin{itemize}
  \item Understanding OpenStreetMap data structure
  \item Building map services with Python
  \item Using Postgis to process data
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{OpenStreetMap}
  \begin{itemize}
  \item Crowd-sourced maps
  \item Free license (CC-by-SA -> ODBL)
  \item Good data coverage for Europe (most)
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Why OSM}
  \begin{itemize}
  \item Easy (except for starters)
  \item Quality (except for non-Europe)
  \item Free (without exceptions)
  \end{itemize}
\end{frame}

\section{Data layout}
\label{sec:diving}

\begin{frame}
  \frametitle{Data types}
  \begin{description}
  \item[Node] Geometric point or point of interest
  \item[Way] Collection of points
  \item[Relation] Collections of objects of any type
  \end{description}
\end{frame}

\begin{frame}
  \frametitle{The data}
  \begin{itemize}
  \item Each object has geometry, tags and changeset information
  \item Tags are simply a list of key/value pairs
  \item Geometry definition differs for different types
  \item Changeset information you shouldn't care about
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{How is it stored?}
  \begin{itemize}
  \item XML (.osm)
  \item Protocol buffers (beta, .pbf)
  \item Other formats through 3rd parties
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Nodes}
  % TODO: add more text before actual xml and python
  \only<1>{}
  \only<2>{\center{\lstinputlisting[language=XML]{nodes.xml}}}
  \only<3>{\lstinputlisting[language=Python]{nodes.py}}
\end{frame}

\begin{frame}
  \frametitle{Ways}
  \only<1>{test}
  \only<2>{\center{\lstinputlisting[language=XML]{ways.xml}}}
  \only<3>{\lstinputlisting[language=Python]{ways.py}}
\end{frame}

\begin{frame}
  \frametitle{Relations}
  \only<1>{test}
  \only<2>{\lstinputlisting[language=XML]{relations.xml}}
  \only<3>{\lstinputlisting[language=Python]{relations.py}}
\end{frame}


\section{Importing}
\label{sec:importing}

\begin{frame}
  \frametitle{Major points when parsing OSM}
  \begin{itemize}
  \item Expect faulty data
  \item Parse iteratively
  \item Cache extensively
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Parsing data: nodes}
  \only<1>{
    \begin{itemize}
    \item Using SAX
    \item Just a simple node parser
    \item Create geometries using Shapely
    \end{itemize}}
  \only<2>{
    \lstinputlisting[firstline=3,lastline=10,language=Python]{nodes-simple.py}
  }
  \only<3>{
    \lstinputlisting[firstline=10,lastline=15,language=Python]{nodes-simple.py}
  }
\end{frame}

\begin{frame}
  \frametitle{Parsing data: ways}
  \only<1>{
    \begin{itemize}
    \item
    \end{itemize}}
  \only<2>{
    \lstinputlisting[firstline=3,lastline=10,language=Python]{ways-simple.py}
  }
  \only<3>{
    \lstinputlisting[firstline=10,lastline=15,language=Python]{ways-simple.py}
  }
\end{frame}

\begin{frame}
  \frametitle{If not feeling adventourous}
  \begin{itemize}
  \item Osmosis -- very
  \item osm2pgsql
  \item osm2mongo, osm2shp
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Backends}
  \begin{itemize}
  \item PostGIS
  \item MongoDB
  \item Spatialite
  \end{itemize}
\end{frame}


\section{Rendering}

\subsection{Definitions}
\label{sec:definitions-1}

\begin{frame}
  \frametitle{Principles}
  \begin{itemize}
  \item Scale
  \item Projection
  \item Cartography
  \item Types of maps
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{How to approach rendering}
  \begin{itemize}
  \item Split your data in layers
  \item Make projection configurable
  \item Provide general way to select data sources
  \item Think about cartographers
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Layers}
  \begin{itemize}
  \item Not exactly physical layers
  \item Layers of graphical representation
  \item Don't render text in several layers
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Rendering sketch}
  \only<1>{
    \begin{itemize}
    \item
    \end{itemize}
  }
  \only<2>{
    \lstinputlisting[language=Python]{rendering-overview.py}
  }
  \only<3>{
    \lstinputlisting[language=Python]{rendering-nodes.py}
  }
  \only<4>{
    \lstinputlisting[language=Python]{rendering-ways.py}
  }
  % \only<>{}
  % \only<>{}
  % \only<>{}
\end{frame}

% TODO add dos and donts?

\begin{frame}
  \frametitle{Doing the rendering}
  cairo,aggdraw
  layer by layer
\end{frame}

\begin{frame}
  mapnik, xml styling
\end{frame}

\begin{frame}
  using indexes in postgis
\end{frame}

\section{Searching}

\begin{frame}
  \frametitle{What's that?}
  \begin{itemize}
  \item Codename geocoding
  \item Similar to magnets
  \item Fast or correct -- choose one
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Why is it hard?}
  \only<1>{
    \begin{itemize}
    \item Fuzzy search
    \item Order matters
    \item But not always
    \item One place can have many names
    \item One name can correspond to many places
    \item People don't care about this at all!
    \end{itemize}
  }
  \only<2>{
    \begin{center}
      \LARGE{I blame Google.}
    \end{center}
  }
\end{frame}

\begin{frame}
  \frametitle{Attempt at implementation}
  \only<1>{
    \begin{itemize}
    \item Make the request structured
    \item Or at least assume order
    \item Assume valid input from users
    \end{itemize}
  }
  \only<2>{
    \lstinputlisting[language=Python]{structured-geocoding-prototype.py}
  }
  \only<3>{
    \lstinputlisting[language=Python]{structured-geocoding-inner.py}
  }
\end{frame}


\begin{frame}
  \frametitle{Fixing user input}
  \only<1>{
    Calculate edit distance
  }
  \only<2>{
    Use Soundex or Metaphone hashing
  }
  \only<3>{
    Trigrams
  }
\end{frame}

\begin{frame}
  \frametitle{Making the search a tad free-form}
  \only<1>{
    Approaching on high level
    How do you know if
  }
  \only<2>{

  }
\end{frame}


% Everything that could go wrong, will go wrong
% Seattle, Washington -> state or city

\begin{frame}
  \frametitle{Edit distance}
  \begin{itemize}
  \item Number of ops required for transforming words
  \item Ops = replace, delete, add, transpose, etc
  \item Doesn't help when looking at several words at once
  \end{itemize}
  trigrams
  levenshtein distance
\end{frame}

\begin{frame}
  levenshtein distance and why it doesn't help
\end{frame}

\begin{frame}
  \frametitle{Terms}
  edit (levenshtein) distance
  fuzzy search
\end{frame}



% http://norvig.com/spell-correct.html




% GIN, GIS, n-grams, levenshtein distance

%% Existing solutions
%% Structured search
%% Fuzzy search
%% Levenstein distance
%% Adding
%% Trigrams
%% PostgreSQL full-text search
%% Why not Soundex/Metaphone/Double metaphone


\section{Routing}

\begin{frame}
  \frametitle{PostgreSQL and PostGIS}

\end{frame}

\begin{frame}
  smart solution with r-trees for storing data
  intersection of ways
\end{frame}

\begin{frame}
  dijkstra, astar, empirical solution
\end{frame}

%% Intro

%% What's OSM
%% License
%% Data quality ?

%% Import

%% How data looks
%% How to use lxml or protobuf for parsing
%% Choosing data storage -- PostGIS, not MySQL or MongoDB or ...
%% General import layout

%% Some benchmarks
%% Some code
%% Some funny images

%% Tiles

%% Rendering
%% Mapnik, etc
%% How to write your renderer
%% Scale the motherfucker

%% Geocoding

%% Routing

%% Building graphs
%% Why importing is harder for routing
%% Pygraph, networkx, igraph

\end{document}
